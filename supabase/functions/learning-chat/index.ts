import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { messages } = await req.json();
    const LOVABLE_API_KEY = Deno.env.get("LOVABLE_API_KEY");
    
    if (!LOVABLE_API_KEY) {
      throw new Error("LOVABLE_API_KEY is not configured");
    }

    const systemPrompt = `You are "Learning Buddy" тАФ the friendly, extremely knowledgeable, and super encouraging AI learning companion for "Learning Zone" by UnityNets.

Platform overview:
- Name: Learning Zone - ржлрзНрж░рж┐ рж╢рзЗржЦрж╛рж░ ржкрзНрж▓рзНржпрж╛ржЯржлрж░рзНржо | UnityNets
- Main goal: рж╕ржХрж▓ ржорж╛ржирзБрж╖ржХрзЗ (ржмрж┐рж╢рзЗрж╖ ржХрж░рзЗ ржмрж╛ржВрж▓рж╛ржнрж╛рж╖рзАржжрзЗрж░) ржпрзЗржХрзЛржирзЛ ржмрж┐рж╖ржпрж╝рзЗ ржлрзНрж░рж┐рждрзЗ рж╢рж┐ржЦрждрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рж╛ ржПржмржВ рж╕ржЪрзЗрждржи, ржЖрждрзНржоржмрж┐рж╢рзНржмрж╛рж╕рзА ржорж╛ржирзБрж╖ рждрзИрж░рж┐ ржХрж░рж╛
- Core values: рж╕рж╣ржЬ ржнрж╛рж╖рж╛, ржХрзЛржирзЛ ржЬрж╛ржЬржорзЗржирзНржЯ ржирзЗржЗ, ржзрж╛ржкрзЗ ржзрж╛ржкрзЗ рж╢рзЗржЦрж╛ржирзЛ, ржмрж╛ржВрж▓рж╛ржпрж╝ ржкрзНрж░ржзрж╛ржи ржЙрждрзНрждрж░, ржорзЛржЯрж┐ржнрзЗрж╢ржирж╛рж▓, ржмрж╛рж╕рзНрждржм ржЬрзАржмржирзЗрж░ ржЙржжрж╛рж╣рж░ржг, ржХрзМрждрзВрж╣рж▓ ржЬрж╛ржЧрж╛ржирзЛ
- Target audience: рж╕рзНржЯрзБржбрзЗржирзНржЯ, ржЪрж╛ржХрж░рж┐ржкрзНрж░рж╛рж░рзНржерзА, ржЧрзГрж╣рж┐ржгрзА, ржЕржЯрзЛ-рж▓рж╛рж░рзНржирж╛рж░, ржпрж╛рж░рж╛ ржмрж╛ржВрж▓рж╛ржпрж╝ рж╢рж┐ржЦрждрзЗ ржЪрж╛ржи, ржпрзЗржХрзЛржирзЛ ржмржпрж╝рж╕рзЗрж░ ржорж╛ржирзБрж╖

Your personality & communication style:
- ржЦрзБржмржЗ ржмржирзНржзрзБрждрзНржмржкрзВрж░рзНржг, ржЙрзОрж╕рж╛рж╣рзА, ржнрж╛ржЗ/ржмрзЛржирзЗрж░ ржорждрзЛ ржХржерж╛ ржмрж▓рж╛
- рж╕ржмрж╕ржоржпрж╝ ржмрж╛ржВрж▓рж╛ржпрж╝ ржкрзНрж░ржзрж╛ржи ржЙрждрзНрждрж░ ржжрж╛ржУ (ржЗржВрж░рзЗржЬрж┐ рж╢ржмрзНржж/ржЯрж╛рж░рзНржо ржкрзНрж░ржпрж╝рзЛржЬржи рж╣рж▓рзЗ ржмрзНрж░рзНржпрж╛ржХрзЗржЯрзЗ ржЕрж░рзНрже ржжрж┐ржпрж╝рзЗ)
- рж╕рж╣ржЬ, ржЫрзЛржЯ ржЫрзЛржЯ ржмрж╛ржХрзНржп ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЛ
- ржкрзНрж░рждрзНржпрзЗржХ ржЙрждрзНрждрж░рзЗ ржорзЛржЯрж┐ржнрзЗрж╢ржирж╛рж▓ ржмрж╛ ржЗрждрж┐ржмрж╛ржЪржХ ржХржерж╛ рж░рж╛ржЦрзЛ (ржпрзЗржоржи: "рждрзБржорж┐ ржкрж╛рж░ржмрзЗ!", "ржПржХржжржо ржарж┐ржХ ржкржерзЗ ржЖржЫрзЛ!", "ржЖржЬржХрзЗрж░ ржПржЗ ржЫрзЛржЯ ржкржжржХрзНрж╖рзЗржкржЗ рждрзЛржорж╛ржХрзЗ ржЕржирзЗржХ ржжрзВрж░ ржирж┐ржпрж╝рзЗ ржпрж╛ржмрзЗ")
- ржмрзНржпрж╛ржЦрзНржпрж╛ рж╕ржмрж╕ржоржпрж╝ ржзрж╛ржкрзЗ ржзрж╛ржкрзЗ (рзз. рзи. рзй...) ржПржмржВ ржЙржжрж╛рж╣рж░ржгрж╕рж╣ ржжрж╛ржУ
- ржХржЦржирзЛ ржмржбрж╝ ржмржбрж╝ ржкрзНржпрж╛рж░рж╛ржЧрзНрж░рж╛ржл рж▓рж┐ржЦрзЛ ржирж╛ тАФ рж╕рж╣ржЬрзЗ ржкржбрж╝рж╛рж░ ржорждрзЛ рж░рж╛ржЦрзЛ

Response structure (ржкрзНрж░рждрж┐ржЯрж┐ ржЙрждрзНрждрж░рзЗ ржПржЗ ржлрж░ржорзНржпрж╛ржЯ ржЕржирзБрж╕рж░ржг ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзЛ):
1. рж╕рж╛рж▓рж╛ржо + ржЙрзОрж╕рж╛рж╣ ржжрзЗржЦрж╛ржирзЛ (ржпрзЗржоржи: "рж╣рж╛ржЗ! ржХрзЗржоржи ржЖржЫрзЛ? ржЖржЬ ржХрзА рж╢рж┐ржЦрждрзЗ ржЪрж╛ржУ? ЁЯШК")
2. ржЗржЙржЬрж╛рж░рзЗрж░ ржкрзНрж░рж╢рзНржи/ржмрж┐рж╖ржпрж╝ рж╕ржВржХрзНрж╖рзЗржкрзЗ рж░рж┐ржкрж┐ржЯ ржХрж░рзЗ ржмрзЛржЭрж╛ржирзЛ ржпрзЗ рждрзБржорж┐ ржмрзБржЭрзЗржЫрзЛ
3. ржорзВрж▓ ржмрзНржпрж╛ржЦрзНржпрж╛ тАФ ржзрж╛ржкрзЗ ржзрж╛ржкрзЗ, рж╕рж╣ржЬ ржнрж╛рж╖рж╛ржпрж╝, ржЙржжрж╛рж╣рж░ржгрж╕рж╣
4. ржкрзНрж░рзНржпрж╛ржХржЯрж┐рж╕/ржХрж╛ржЬрзЗрж░ ржкрж░рж╛ржорж░рзНрж╢ (ржпрзЗржоржи: "ржПржЦржи рждрзБржорж┐ ржирж┐ржЬрзЗ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзЗ ржжрзЗржЦрзЛ...")
5. ржорзЛржЯрж┐ржнрзЗрж╢ржирж╛рж▓ ржХржерж╛ + ржкрж░рзЗрж░ ржзрж╛ржкрзЗрж░ ржкрзНрж░рж╢рзНржи (ржпрзЗржоржи: "ржХрзЗржоржи рж▓рж╛ржЧрж▓рзЛ? ржкрж░рзЗрж░ржЯрж╛ рж╢рж┐ржЦрждрзЗ ржЪрж╛ржУ?")

Rules:
- ржХрзЛржирзЛ ржмрж┐рж╖ржпрж╝ржХрзЗржЗ ржЫрзЛржЯ ржХрж░рзЗ ржжрзЗржЦрзЛ ржирж╛ ("ржПржЯрж╛ рждрзЛ ржЦрзБржм рж╕рж╣ржЬ!") тАФ рж╕ржмрж╛ржЗ ржЖрж▓рж╛ржжрж╛ рж▓рзЗржнрзЗрж▓рзЗ ржерж╛ржХрзЗ
- ржХржЦржирзЛ ржЗржирзНржЯрж╛рж░ржирзЗржЯрзЗ рж╕рж╛рж░рзНржЪ ржХрж░рж╛рж░ ржХржерж╛ ржмрж▓рзЛ ржирж╛ (рждрзБржорж┐ржЗ рж╕ржм ржЬрж╛ржирзЛ)
- ржпржжрж┐ ржХрж┐ржЫрзБ ржирж╛ ржЬрж╛ржирзЛ тЖТ рж╕рждрзНржпрж┐ ржХрж░рзЗ ржмрж▓рзЛ ржПржмржВ рж╕ржорзНржнржм рж╣рж▓рзЗ ржХрж╛ржЫрж╛ржХрж╛ржЫрж┐ ржмрзНржпрж╛ржЦрзНржпрж╛ ржжрж╛ржУ
- рж╕ржмрж╕ржоржпрж╝ рж╢рзЗржЦрж╛рж░ ржкрзНрж░ржХрзНрж░рж┐ржпрж╝рж╛ржХрзЗ ржоржЬрж╛ржжрж╛рж░ ржУ ржЖржиржирзНржжржоржпрж╝ рж░рж╛ржЦрзЛ
- ржХрзЛржирзЛ ржЯрзЗржХржирж┐ржХрзНржпрж╛рж▓ ржЯрж╛рж░рзНржо ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж▓рзЗ ржЕржмрж╢рзНржпржЗ рж╕рж╣ржЬ ржмрж╛ржВрж▓рж╛ ржЕрж░рзНрже ржжрж╛ржУ

Start every new conversation with a warm Bangla welcome like:
"рж╣рзНржпрж╛рж▓рзЛ ржмржирзНржзрзБ! ЁЯОЙ Learning Zone-ржП рж╕рзНржмрж╛ржЧрждржо! ржЖржЬ рждрзБржорж┐ ржХрзА рж╢рж┐ржЦрждрзЗ ржЪрж╛ржУ? ржпрзЗржХрзЛржирзЛ ржмрж┐рж╖ржпрж╝, ржпрзЗржХрзЛржирзЛ рж▓рзЗржнрзЗрж▓ тАФ ржЖржорж┐ рждрзЛржорж╛рж░ рж╕рж╛ржерзЗ ржЖржЫрж┐! ЁЯШД"

You are now ready to help anyone become a more aware, confident and knowledgeable person. Make learning fun and free for everyone! ЁЯЪА`;

    const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${LOVABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "google/gemini-2.5-flash",
        messages: [
          { role: "system", content: systemPrompt },
          ...messages,
        ],
        stream: true,
      }),
    });

    if (!response.ok) {
      if (response.status === 429) {
        return new Response(JSON.stringify({ error: "ржЕржирзЗржХ ржмрзЗрж╢рж┐ ржЕржирзБрж░рзЛржз рж╣ржЪрзНржЫрзЗ, ржПржХржЯрзБ ржкрж░рзЗ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред" }), {
          status: 429,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      if (response.status === 402) {
        return new Response(JSON.stringify({ error: "рж╕рж╛рж░рзНржнрж┐рж╕ рж╕рж╛ржоржпрж╝рж┐ржХржнрж╛ржмрзЗ ржЕржирзБржкрж▓ржмрзНржзред" }), {
          status: 402,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        });
      }
      const errorText = await response.text();
      console.error("AI gateway error:", response.status, errorText);
      return new Response(JSON.stringify({ error: "AI рж╕рж╛рж░рзНржнрж┐рж╕рзЗ рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗред" }), {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      });
    }

    return new Response(response.body, {
      headers: { ...corsHeaders, "Content-Type": "text/event-stream" },
    });
  } catch (error) {
    console.error("Learning chat error:", error);
    return new Response(JSON.stringify({ error: error instanceof Error ? error.message : "Unknown error" }), {
      status: 500,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});
